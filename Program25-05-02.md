# 🛠️ Road System 開發紀錄｜2025/5/2

## 🎯 目標

建構一套支援等角地圖上自由建造／刪除道路的系統，需符合以下條件：

- 支援滑鼠精準選取地圖格子
- 支援區塊系統（如 B1、B2 區）
- 滑鼠拖曳建路／刪路（非單點點擊）
- 可預覽、轉角自動顯示、道路建造後樣式正確
- 每次建造與刪除後自動更新周圍連接
- 支援無連接圖與已建成道路刪除

---

## ✅ 本次完成內容

### 1️⃣ 地圖系統建置

- [x] 成功對齊地圖中心 (`(0,0)` 對應格子 17,17)
- [x] 格子能精準映射回 `Vector2Int` 格座標
- [x] 引入區塊系統（如 A0～E4，7x7 分塊）
- [x] 地圖邊界限制 + 拖曳鏡頭 + 建造模式下禁用鍵盤拖動
- [x] 格子區判斷是否為可建區（例如僅 B1、B2）

---

### 2️⃣ 道路建設系統 RoadManager

#### 🧱 建置功能

- [x] 預覽建造：滑鼠拖曳路徑會產生透明白色預覽 tile
- [x] 按下空白鍵建造後轉為正式 tile
- [x] 預設每條預覽道路都使用自動轉角樣式（角落、T字、十字）

#### 🔁 刪除功能

- [x] 再次拖曳經過已建或預覽格子時 → 標記為「待刪除」
- [x] 放開滑鼠後刪除紅色 tile
- [x] 預覽刪除為「紅色半透明」，建成刪除為「紅色不透明」

#### 🔍 自動樣式更新

- [x] 所有建成或刪除動作後會呼叫 `UpdateSurrounding()`
- [x] 使周圍路格根據連接關係套用對應轉角圖案

---

### 3️⃣ 圖片資源與轉角圖對應

- [x] 建立完整 12 張道路圖素材（含轉角、直線、T 字與單點）
- [x] 圖片對應編號依據 UDLR → `GetCorrectSprite()` 映射修正如下：
(因為是等角視角，所有理解方向皆以右上角為上方。)
(↗為方塊上方方向，同理以下的說明裡左邊就是"↖")

| 索引 | 名稱   | 連接狀態 UDLR | 說明        |
|------|--------|----------------|-------------|
| 0    | 下轉   | 1001           | ↱         |
| 1    | 上轉   | 0110           | ↲         |
| 2    | 直右撇 | 0101           | —           |
| 3    | 左轉   | 1100           | ↰           |
| 4    | 右轉   | 0011           | ↳           |
| 5    | 直左撇 | 1010           | |           |
| 6    | 左T    | 1101           | T ←         |
| 7    | 上T    | 1110           | T ↑         |
| 8    | 下T    | 0111           | T ↓         |
| 9    | 右T    | 1011           | T →         |
| 10   | 十字   | 1111           | 十字交叉    |
| 11   | 十字   | 0000           | 無連接預設圖 |

---

## 🔎 解決過的 bug / 調整點

- [x] Sprite 建造後消失：解決 Confirm 時未再指定 Sprite 的問題，已確認為圖片素材引用問題，再次重設定為256像素每格與全矩形就可解決
- [x] 預覽建造模式圖片無法顯示：解決素材導入錯誤（Alpha 未勾選 / 圖錯誤）
- [x] 預覽 tile 閃爍：加入 `lastHoverPos` 判斷避免重複操作
- [x] 預覽模式拖曳時錯亂：限定拖曳起點決定建造／刪除模式
- [x] 建立後樣式錯誤：導入 `UpdateSurrounding()` 讓周邊道路同步更新樣式
- [x] 無法刪除已建格子：加入建成 tile 標記與刪除清單
- [x] GetCorrectSprite 無對應 fallback：新增第 12 張「無連接預設圖」

---

## 🚀 下一步建議

### 📦 建築系統接入
- 每塊格子可建造伐木場、農田等設施
- 道路與建築連接判斷功能（例：需接到道路才啟用）

### 💾 資料儲存
- 儲存地圖目前已建設格子為 JSON
- 讀檔時自動生成對應 tile 與樣式

### 💡 UX 強化
- 加入建造／刪除動畫與音效
- 滑鼠右鍵取消所有標記／預覽
- 支援連續多段建造（筆刷模式）

---
加油，我們可以的！